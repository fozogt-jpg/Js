<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jstore — Apps</title>
  <link id="manifestLink" rel="manifest" />
  <style>
    :root{
      --bg:#000000; --primary:#29b6f6; --muted:#9aa3ad; --radius:12px;
      font-family: Roboto, "Helvetica Neue", Arial, sans-serif; color-scheme: dark;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:#e6eef6;}
    *{box-sizing:border-box}

    .app-wrap{ display:flex; min-height:100vh; }

    /* Sidebar */
    .sidebar { width:84px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-right:1px solid rgba(255,255,255,0.03); padding:12px 8px; display:flex; flex-direction:column; align-items:center; gap:12px; }
    .brand { width:56px; height:56px; border-radius:12px; overflow:hidden; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; margin-bottom:6px; border:1px solid rgba(255,255,255,0.02); }
    .brand img{ width:44px; height:44px; object-fit:cover; }
    .nav-btn { width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .12s ease; color:var(--muted); background:transparent; border:0; }
    .nav-btn:hover { transform: translateY(-3px); color:var(--primary); background: rgba(46,199,255,0.03); }
    .nav-btn.active { color: white; box-shadow: 0 6px 18px rgba(0,0,0,0.6); background: linear-gradient(180deg, rgba(46,199,255,0.06), rgba(46,199,255,0.02)); border: 1px solid rgba(46,199,255,0.12); }

    .main { flex:1; padding:18px; max-width:1200px; margin:0 auto; width:100%; }
    header{ display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .logo { display:flex; align-items:center; gap:10px; }
    .logo img{ width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    .brand-name { font-weight:700; font-size:18px; color:#eaf6ff; }

    .search { margin-left:8px; background: rgba(255,255,255,0.02); padding:8px; border-radius:10px; display:flex; align-items:center; gap:8px; min-width:250px; border:1px solid rgba(255,255,255,0.02); }
    .search input{ border:0; outline:0; background:transparent; color:#dff6ff; font-size:14px; width:100%; }

    .btn { background:var(--primary); color:#001921; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn.ghost { background:transparent; color:var(--primary); border:1px solid rgba(46,199,255,0.12); }

    .featured { display:flex; gap:18px; margin-bottom:18px; }
    .hero { flex:1; border-radius:var(--radius); padding:18px; min-height:120px; position:relative; background: linear-gradient(90deg, rgba(14,165,255,0.06), rgba(41,182,246,0.03)); border:1px solid rgba(255,255,255,0.02); }
    .hero h2 { margin:0; color:#dff6ff; }
    .hero p { margin:4px 0 0 0; color:var(--muted); }

    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:14px; }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.6); display:flex; gap:12px; align-items:center; border:1px solid rgba(255,255,255,0.02); transition: transform .12s ease, box-shadow .12s ease; }
    .card:hover { transform: translateY(-6px); box-shadow:0 18px 50px rgba(0,0,0,0.7); }
    .card .icon { width:64px; height:64px; border-radius:16px; overflow:hidden; flex-shrink:0; background:#071013; display:flex; align-items:center; justify-content:center; }
    .card .icon img{ width:100%; height:100%; object-fit:cover; }
    .card .info h3{ margin:0; font-size:16px; color:#e6f9ff; }
    .card .info p{ margin:6px 0 0 0; color:var(--muted); font-size:13px; }
    .card .actions { display:flex; flex-direction:column; gap:8px; align-items:flex-end; }

    /* Modal + preview area — image is shown fully (no cropping) and shrunk to fit */
    .modal { position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; z-index:60; padding:40px; overflow:auto; background: linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)); }
    .modal.open{ display:flex; }
    .panel{ width:1100px; max-width:calc(100% - 48px); border-radius:14px; overflow:hidden; background: linear-gradient(180deg, rgba(10,12,15,0.96), rgba(8,10,12,0.98)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 20px 60px rgba(0,0,0,0.8); }

    /* Preview wrapper maintains 16:9 area but the <img> uses object-fit: contain so the whole image is visible and scaled to fit. */
    .preview-wrap {
      width:100%;
      aspect-ratio: 16 / 9;
      max-height: 80vh;
      min-height: 220px;
      position:relative;
      background: #07090b;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    #previewImg {
      display:block;
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      object-fit:contain; /* ensures full image is visible and shrunk to fit */
      object-position:center;
      background-color:#000; /* letterbox color */
      -webkit-user-drag: none;
      user-select:none;
    }
    .preview-overlay {
      position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.04)); pointer-events:none;
    }
    .app-meta {
      position:absolute; left:18px; bottom:18px; z-index:2;
      display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px;
      background: linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.08));
    }
    .app-icon{ width:96px; height:96px; border-radius:18px; overflow:hidden; background:#071013; flex-shrink:0; }
    .app-icon img{ width:100%; height:100%; object-fit:cover; }

    .app-body { padding:18px; display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    .app-body .desc { color:#e6eef6; }
    .app-body .side { display:flex; flex-direction:column; gap:12px; }
    .small{ font-size:13px; color:var(--muted); }

    @media (max-width:1100px){ .panel { width:calc(100% - 36px); } .app-body { grid-template-columns: 1fr 240px; } }
    @media (max-width:880px){
      .sidebar { display:flex; flex-direction:row; width:100%; height:64px; padding:8px; gap:8px; align-items:center; justify-content:flex-start; overflow-x:auto; border-right: none; border-bottom:1px solid rgba(255,255,255,0.02); }
      .app-wrap { flex-direction:column; }
      .main { padding:12px; max-width:100%; margin:0; }
      .app-body { grid-template-columns: 1fr; }
      .nav-label { display:none; }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main">
      <div class="brand" title="Jstore">
        <img src="images/logo.png" alt="Jstore logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\'><rect width=\\'24\\' height=\\'24\\' fill=\\'%2329b6f6\\'/></svg>'">
      </div>

      <button class="nav-btn active" data-panel="home" title="Home" aria-pressed="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z"/></svg>
      </button>

      <button class="nav-btn" data-panel="categories" title="Categories" aria-pressed="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
      </button>

      <button class="nav-btn" data-panel="library" title="Library" aria-pressed="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6v12h16V6H4zm2 2h12v8H6V8z"/></svg>
      </button>

      <button class="nav-btn" data-panel="settings" title="Settings" aria-pressed="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 2.27 17.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.23-.39 1.51-1a1.65 1.65 0 0 0-.33-1.82L4.3 3.33A2 2 0 1 1 7.13.5l.06.06A1.65 1.65 0 0 0 9 1.89V2a2 2 0 1 1 4 0v.09c.66 0 1.23.39 1.51 1 .28.61.97 1 1.82.33l.06-.06A2 2 0 1 1 21.73 6.1l-.06.06a1.65 1.65 0 0 0-.33 1.82c.28.61.97 1 1.51 1H21a2 2 0 1 1 0 4h-.09c-.61 0-1.23.39-1.51 1z"/></svg>
      </button>

      <div style="flex:1"></div>
      <div class="nav-label" style="font-size:11px; color:var(--muted); text-align:center; padding:6px 4px;">Jstore</div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <header>
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="logo">
            <img src="images/logo.png" alt="Jstore" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\'><rect width=\\'24\\' height=\\'24\\' fill=\\'%230ea5ff\\'/></svg>'" />
            <div class="brand-name">Jstore</div>
          </div>

          <div class="search" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.9"><path d="M21 21l-4.35-4.35" stroke="var(--muted)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="var(--muted)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <input id="searchInput" placeholder="Search apps, games..." aria-label="Search apps">
          </div>
        </div>

        <div style="margin-left:auto;">
          <button class="btn ghost" id="refreshBtn" title="Refresh apps">Refresh</button>
        </div>
      </header>

      <section class="featured">
        <div class="hero">
          <div>
            <h2>Featured</h2>
            <p>Trending apps from the Jstore catalog.</p>
          </div>
        </div>
      </section>

      <section>
        <div class="grid" id="appsGrid" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <!-- Modal showing full preview (shrunken to fit) -->
  <div class="modal" id="appModal" role="dialog" aria-hidden="true">
    <div class="panel" role="document">
      <div class="preview-wrap" id="previewWrap">
        <img id="previewImg" alt="App preview" src="" />
        <div class="preview-overlay"></div>
        <div class="app-meta" id="appMeta">
          <div class="app-icon" id="detailIcon"><img src="" alt=""></div>
          <div style="color:white">
            <div id="detailName" style="font-size:18px;font-weight:700"></div>
            <div id="detailDev" class="small"></div>
          </div>
        </div>
      </div>

      <div class="app-body">
        <div class="desc">
          <h3 id="detailTitle"></h3>
          <p id="detailDescription" class="small"></p>
        </div>
        <div class="side">
          <div>
            <button class="btn" id="installBtn">Install</button>
            <button class="btn ghost" id="closeBtn" style="margin-left:8px">Close</button>
          </div>
          <div class="small">Full preview shown and scaled to fit the app window (no cropping).</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== Config & DOM refs ========== */
const APPS_JSON_URL = 'https://fozogt-jpg.github.io/Js/apps/apps.json';
const appsGrid = document.getElementById('appsGrid');
const searchInput = document.getElementById('searchInput');
const refreshBtn = document.getElementById('refreshBtn');

const modal = document.getElementById('appModal');
const previewImg = document.getElementById('previewImg');
const detailIcon = document.getElementById('detailIcon');
const detailName = document.getElementById('detailName');
const detailDev = document.getElementById('detailDev');
const detailTitle = document.getElementById('detailTitle');
const detailDescription = document.getElementById('detailDescription');
const installBtn = document.getElementById('installBtn');
const closeBtn = document.getElementById('closeBtn');

let apps = [];
let currentApp = null;

/* ========== Apps loading & rendering ========== */
async function loadApps(){
  try {
    const resp = await fetch(APPS_JSON_URL, {cache: "no-store"});
    if(!resp.ok) throw new Error('Network response not ok');
    const json = await resp.json();
    apps = Array.isArray(json) ? json : (json.apps || []);
    try { localStorage.setItem('jstore_apps_cache', JSON.stringify(apps)); } catch(_) {}
    renderApps(apps);
  } catch (err) {
    console.warn('Failed to load remote apps.json:', err);
    try {
      const fallbackResp = await fetch('/apps.json');
      if (fallbackResp.ok){
        const localJson = await fallbackResp.json();
        apps = Array.isArray(localJson) ? localJson : (localJson.apps || []);
        renderApps(apps);
        return;
      }
    } catch(e){}
    const cached = localStorage.getItem('jstore_apps_cache');
    if (cached){
      try {
        apps = JSON.parse(cached);
        renderApps(apps);
        return;
      } catch(e){}
    }
    appsGrid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:var(--muted)">Unable to load apps. Check apps.json URL or network.</div>';
  }
}

function renderApps(list){
  const q = (searchInput.value || '').trim().toLowerCase();
  const filtered = list.filter(a => {
    if(!a.name) return true;
    if(!q) return true;
    return (a.name + ' ' + (a.developer||'') + ' ' + (a.description||'')).toLowerCase().includes(q);
  });
  if(filtered.length === 0){
    appsGrid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:var(--muted)">No apps found.</div>';
    return;
  }
  appsGrid.innerHTML = '';
  filtered.forEach((app, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="icon"><img src="${escapeHtml(app.icon || '')}" alt="${escapeHtml(app.name || 'app icon')}" onerror="this.style.background='#071013'; this.src='images/default-icon.png'"></div>
      <div class="info">
        <h3>${escapeHtml(app.name || ('App ' + (idx+1)))}</h3>
        <p>${escapeHtml(app.developer || '')}</p>
      </div>
      <div class="actions">
        <button class="btn" data-idx="${idx}">Install</button>
        <button class="btn ghost" data-open="${idx}">Open</button>
      </div>
    `;
    card.querySelector('button.btn').addEventListener('click', ()=> openAppUrl(app));
    card.querySelector('button.ghost').addEventListener('click', ()=> showDetails(app));
    appsGrid.appendChild(card);
  });
}

/* ========== Show details: display full preview scaled to fit ========== */
function showDetails(app){
  currentApp = app;
  detailIcon.innerHTML = `<img src="${escapeHtml(app.icon||'')}" alt="${escapeHtml(app.name||'')}" onerror="this.src='images/default-icon.png'">`;
  detailName.textContent = app.name || 'Unnamed App';
  detailDev.textContent = app.developer || '';
  detailTitle.textContent = app.name || 'App';
  detailDescription.textContent = app.description || '';
  installBtn.onclick = () => openAppUrl(app);

  // show the full preview image and let CSS shrink it (object-fit: contain)
  const previewUrl = app.preview_image || '';
  if (previewUrl) {
    // add cache-bust to avoid stale images when testing
    previewImg.src = previewUrl + (previewUrl.includes('?') ? '&' : '?') + 'cb=' + Date.now();
  } else {
    previewImg.src = '';
  }

  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}

function closeDetails(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
  currentApp = null;
  previewImg.src = '';
  document.body.style.overflow = '';
}

function openAppUrl(app){
  if(!app || !app.url){ alert('No URL provided for this app.'); return; }
  window.open(app.url, '_blank', 'noopener,noreferrer');
}

function escapeHtml(s){
  if(s == null) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/* Sidebar nav behaviour */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
  });
});

/* Events */
searchInput.addEventListener('input', ()=> renderApps(apps));
refreshBtn.addEventListener('click', ()=> loadApps());
closeBtn.addEventListener('click', closeDetails);
modal.addEventListener('click', (e)=> { if(e.target === modal) closeDetails(); });

/* ========== Embedded manifest + service worker (blobs) ========== */
(function setupEmbeddedPWA(){
  const manifest = {
    name: "Jstore",
    short_name: "Jstore",
    description: "A Progressive Web App store — Jstore",
    start_url: "/",
    scope: "/",
    display: "standalone",
    background_color: "#000000",
    theme_color: "#29b6f6",
    icons: [
      { src: "images/icon-192.png", sizes: "192x192", type: "image/png" },
      { src: "images/icon-512.png", sizes: "512x512", type: "image/png" }
    ]
  };

  try {
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
    const manifestUrl = URL.createObjectURL(manifestBlob);
    document.getElementById('manifestLink').setAttribute('href', manifestUrl);
  } catch (e) { console.warn('Could not create manifest blob:', e); }

  const swSource = `
    const CACHE_NAME = 'jstore-cache-v1';
    const PRECACHE_URLS = ['/', '/index.html', 'images/logo.png', 'images/default-icon.png', 'images/icon-192.png', 'images/icon-512.png', '/apps.json'];

    self.addEventListener('install', event => {
      event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(PRECACHE_URLS).catch(err => console.warn('Precache failed',err))).then(()=>self.skipWaiting()));
    });

    self.addEventListener('activate', event => {
      event.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => { if(k !== CACHE_NAME) return caches.delete(k); }))).then(()=>self.clients.claim()));
    });

    self.addEventListener('fetch', event => {
      const request = event.request;
      if (request.url.includes('/apps.json') || request.url.includes('fozogt-jpg.github.io/Js/apps/apps.json')) {
        event.respondWith(fetch(request).then(response => { const copy = response.clone(); caches.open(CACHE_NAME).then(cache => cache.put(request, copy)); return response; }).catch(_ => caches.match(request).then(r => r || caches.match('/apps.json'))));
        return;
      }
      if (request.mode === 'navigate' || (request.headers.get('accept') || '').includes('text/html')) {
        event.respondWith(caches.match('/index.html').then(cached => cached || fetch(request).catch(()=>caches.match('/index.html'))));
        return;
      }
      event.respondWith(caches.match(request).then(cachedResponse => {
        if (cachedResponse) return cachedResponse;
        return fetch(request).then(networkResp => {
          if(request.method === 'GET' && networkResp && networkResp.status === 200 && networkResp.type !== 'opaque') {
            const copy = networkResp.clone();
            caches.open(CACHE_NAME).then(cache => cache.put(request, copy));
          }
          return networkResp;
        }).catch(()=>{});
      }));
    });
  `;

  if ('serviceWorker' in navigator) {
    try {
      const swBlob = new Blob([swSource], {type: 'application/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl, {scope: '/'})
        .then(reg => { console.log('Embedded SW registered:', reg.scope); try{ URL.revokeObjectURL(swUrl); }catch(e){} })
        .catch(err => console.warn('Service worker registration failed:', err));
    } catch (e) { console.warn('Failed to create/register SW blob:', e); }
  } else { console.warn('Service workers not supported in this browser.'); }
})();

/* Initial load */
loadApps();
</script>
</body>
</html>
